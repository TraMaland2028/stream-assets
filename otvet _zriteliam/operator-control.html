<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Operator Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f10; --fg:#e8f0f2; --acc:#ffa733; --mut:#7c8a8e;
    }
    *{ box-sizing:border-box; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--fg); display:grid; place-items:center; min-height:100vh; }
    .card{
      width:min(900px, 96vw);
      background:#101518;
      border:2px solid #1f2a2e; border-radius:16px; padding:20px;
    }
    h1{ margin:0 0 12px; font-size:20px; color:#ffd27a; }
    .row{ display:flex; gap:12px; margin:10px 0; align-items:center; }
    textarea{
      width:100%; height:160px; resize:vertical; padding:12px;
      border:2px solid #26343a; border-radius:12px; background:#0f1518; color:#ffd27a; outline:none;
    }
    textarea:focus{ border-color:#35505a; }
    label{ font-size:14px; color:var(--mut); }
    input[type="number"]{ width:100px; padding:8px; border:2px solid #26343a; border-radius:10px; background:#0f1518; color:#e8f0f2; }
    select{ padding:8px; border:2px solid #26343a; border-radius:10px; background:#0f1518; color:#e8f0f2; }
    .actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{
      padding:10px 14px; border-radius:12px; border:2px solid #2b3a40; background:#142025; color:#e8f0f2; cursor:pointer;
    }
    button.primary{ border-color:#ffa73340; background:#1c2a2f; color:#ffd27a; }
    button.warn{ border-color:#ff6a0040; background:#2a1c18; color:#ffb188; }
    button:hover{ filter:brightness(1.06); }
    .muted{ color:var(--mut); font-size:13px; }
    .ok{ color:#77ff99; }
    .err{ color:#ff7777; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Пульт оператора</h1>
    <div class="row">
      <textarea id="msg" placeholder="Введите текст для оранжевого окна…"></textarea>
    </div>
    <div class="row" style="flex-wrap:wrap">
      <label>Сторона:
        <select id="side">
          <option value="left">слева</option>
          <option value="right">справа</option>
        </select>
      </label>
      <label>Скорость печати (cps):
        <input id="cps" type="number" min="4" max="60" step="1" value="18">
      </label>
      <label>Автоскрытие (сек, 0 = не скрывать):
        <input id="hide" type="number" min="0" max="300" step="1" value="0">
      </label>
    </div>
    <div class="actions">
      <button class="primary" id="send">Показать сообщение</button>
      <button id="hideBtn" class="warn">Скрыть сообщение</button>
      <button id="demo">Демо-текст</button>
      <button id="clear">Очистить поле</button>
    </div>
    <p class="muted" id="status">Канал: <span id="chan" class="ok">BroadcastChannel</span> (резерв: localStorage)</p>
    <p class="muted">Окно оператора должно быть загружено как <code>operator.html</code> с того же адреса (origin), что и этот пульт.</p>
  </div>

  <script>
    const CH_NAME = 'operator_channel_v1';
    let channel = null, usingBroadcast = false;

    try {
      channel = new BroadcastChannel(CH_NAME);
      usingBroadcast = true;
    } catch (e) {
      channel = null;
    }

    const $ = sel => document.querySelector(sel);
    const statusEl = $('#status');

    function updateStatus(ok, msg){
      statusEl.innerHTML = ok
        ? `Канал: <span class="ok">${msg}</span> (резерв: localStorage)`
        : `Канал: <span class="err">${msg}</span> · пробую localStorage`;
    }
    updateStatus(usingBroadcast, usingBroadcast ? 'BroadcastChannel' : 'нет');

    function sendPacket(pkt){
      pkt.__t = Date.now();
      if (usingBroadcast && channel){
        channel.postMessage(pkt);
      } else {
        try { localStorage.setItem('operator_packet', JSON.stringify(pkt)); } catch(e){}
      }
    }

    $('#demo').onclick = () => {
      $('#msg').value = 'Внимание: через 10 минут общий свет погаснет на техобслуживание. Возьмите тёплые пледы — и не теряйте надежду.';
    };
    $('#clear').onclick = () => { $('#msg').value = ''; };

    $('#send').onclick = () => {
      const msg  = ($('#msg').value || '').trim();
      const side = $('#side').value;
      const cps  = Math.max(4, Math.min(60, Number($('#cps').value||18)));
      const hide = Math.max(0, Math.min(300, Number($('#hide').value||0)));
      if (!msg){ alert('Введите текст.'); return; }
      sendPacket({ kind:'operator_message', payload:{ message: msg, side, cps, hide } });
    };

    $('#hideBtn').onclick = () => {
      sendPacket({ kind:'operator_hide' });
    };
  </script>
</body>
</html>
